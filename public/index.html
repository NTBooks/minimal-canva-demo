<!DOCTYPE html>
<html lang="en">

<!-- This demo only uses vanilla JS, you can replace it with the client framework of your choice -->
<!-- "This tool assumes you already have a saved project in canva with your customizable credential" -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Canva</title>

    <!-- Add Bootstrap from CDN since that's not the purpose of this code demo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="style.css">
    <script src="canva_endpoints.js"></script>
    <script src="dom_utils.js"></script>
</head>

<body>
    <script>
        let userToken = null;

        // Handle the popup canva auth request
        function handlePopup() {
            try {
                var popup = window.open('/canva/approve', 'popup', 'width=480,height=800');
                var popupChecker = setInterval(function () {
                    if (popup.closed) {
                        clearInterval(popupChecker);

                        hideById('login');

                        fetchWhoami();
                    }
                }, 500); // Check every 500ms
                return false;
            } catch (error) {
                console.error('Error opening popup:', error);
            }
        }

        // fetch GET /whoami and write text to the whoami div below
        async function fetchWhoami() {
            try {
                const response = await fetch('/whoami');
                const data = await response.text();

                userToken = JSON.parse(data)?.status;

                if (userToken) {
                    hideById('login');
                    showById('starthidden');
                    setInnerText('whoami', "Got user token!");

                    // Store the userToken in localStorage for persistence
                    localStorage.setItem('canvaToken', userToken);
                }

            } catch (error) {
                console.error('Error fetching whoami:', error);
            }
        }

        function PollJobStatus(exportid) {
            setTimeout(async () => {
                try {
                    const response = await CanvaFetch('exports/' + exportid, 'GET', null);

                    const data = await response.json();
                    console.log(data);

                    if (data.job?.status === "success") {
                        console.log("FOUND IT!")
                        document.getElementById('imgresult').src = data.job?.urls?.[0];
                        document.getElementById('imgresult').style.display = 'block';
                        document.getElementById('postimage').style.display = 'block';

                        // remove the querystring from the url in the address bar without reloading
                        window.history.pushState({}, document.title, "/");


                    } else {
                        PollJobStatus(exportid);
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Polling aborted');
                    } else {
                        console.error('Error fetching job status:', error);
                    }
                }
            }, 2000);


        }

        window.addEventListener('load', function () {

            userToken = localStorage.getItem('canvaToken');

            if (userToken) {
                fetchWhoami();
            }

            // This is our return path from Canva after a user makes a design
            // if the querystring has a waitid start polling
            const urlParams = new URLSearchParams(window.location.search);
            const waitid = urlParams.get('waitid');

            if (waitid) {
                PollJobStatus(waitid);
            }
        });

        async function postImageToServer() {
            const imgElement = document.getElementById('imgresult');
            const imgSrc = imgElement.src;

            if (!imgSrc) {
                console.error('No image source found');
                return;
            }

            try {
                const response = await fetch(imgSrc);
                const blob = await response.blob();

                const formData = new FormData();
                formData.append('image', blob, waitid + '.png');

                const serverResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await serverResponse.json();
                console.log('Image posted successfully:', result);
            } catch (error) {
                console.error('Error posting image:', error);
            }
        }


    </script>
    <h1>Welcome to Minimal Canva Integration</h1>

    <a id="login" href="#" onclick="handlePopup()">Canva Auth</a>


    <div id="starthidden">
        <a id="logout" href="#" onclick="clearLocalStorage()">Logout</a>
        <div id="whoami">

        </div>
        <a href="/newdesign">Create New Design</a>

        <img id="imgresult" class="fadeIn"></img>

        <button id="postimage" class="fadeIn" onclick="postImageToServer()">Post Image to Server</button>
    </div>


</body>

</html>